<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearpeer AI</title>
<meta name="application-name" content="Nearpeer AI">
<meta property="og:title" content="Nearpeer AI">
<meta name="twitter:title" content="Nearpeer Ai">
<meta name="apple-mobile-web-app-title" content="Nearpeer AI">

    <link rel="icon" type="image/png" href="favicon.png">
    <!-- MathJax for beautiful math rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        // Configure MathJax BEFORE loading the library
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Configuration file - keep this secure -->
    <!-- <script src="config.js"></script> -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #212121;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #212121;
            border-bottom: 1px solid #2d2d2d;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            height: 32px;
            width: auto;
        }

        .new-chat-btn {
            background: transparent;
            color: #ffffff;
            border: 1px solid #2d2d2d;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .new-chat-btn:hover {
            background: #2d2d2d;
            border-color: #404040;
        }

        /* Hide mobile new chat button in desktop view */
        .mobile-new-chat {
            display: none;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .model-selector {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8e8e8e;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .model-selector:hover {
            background: #2d2d2d;
        }

        .model-selector select {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
            pointer-events: none;
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 1rem;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            pointer-events: auto;
        }

        .settings-dropdown.show {
            display: block;
        }

        .settings-section {
            margin-bottom: 1rem;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h4 {
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #404040;
            padding-bottom: 0.25rem;
        }

        .settings-item {
            margin-bottom: 0.75rem;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            display: block;
            color: #8e8e8e;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .settings-input {
            width: 100%;
            background: #171717;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            pointer-events: auto;
            z-index: 1002;
            position: relative;
        }

        .settings-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .settings-range {
            width: 100%;
            margin: 0.25rem 0;
        }

        .range-value {
            color: #10a37f;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .settings-hint {
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .model-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .model-btn {
            background: #171717;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .model-btn:hover {
            background: #2d2d2d;
            border-color: #10a37f;
        }

        .model-btn.active {
            background: #10a37f;
            border-color: #10a37f;
            color: white;
        }

        .reasoning-effort-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .reasoning-effort-btn {
            background: #171717;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .reasoning-effort-btn:hover {
            background: #2d2d2d;
            border-color: #10a37f;
        }

        .reasoning-effort-btn.active {
            background: #10a37f;
            border-color: #10a37f;
            color: white;
        }





        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem;
            height: calc(100vh - 80px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 0;
            min-height: 0;
        }

        .message {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: #10a37f;
        }

        .message.assistant .message-avatar {
            background: transparent;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .message-content {
            background: #2d2d2d;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ffffff;
        }

        .message-content p {
            margin: 0 0 1rem 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin: 0.5rem 0 1rem 1.5rem;
        }

        .message-content li {
            margin: 0.25rem 0;
        }

        .message-content blockquote {
            border-left: 4px solid #10a37f;
            margin: 1rem 0;
            padding-left: 1rem;
            color: #6b7280;
            font-style: italic;
        }

        .message-content code {
            background: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 1.5rem 0 0.5rem 0;
            color: #374151;
            font-weight: 600;
        }

        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.3rem; }
        .message-content h3 { font-size: 1.1rem; }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        .message-content th, .message-content td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            text-align: left;
        }

        .message-content th {
            background: #f9fafb;
            font-weight: 600;
        }

        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(16, 163, 127, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .message:hover .copy-button {
            opacity: 1;
        }



        .copy-button:hover {
            background: rgba(16, 163, 127, 1);
        }

        .copy-options {
            position: absolute;
            top: 2rem;
            right: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            display: none;
            z-index: 20;
        }

        .copy-options.show {
            display: block;
        }

        .copy-option {
            display: block;
            width: 100%;
            padding: 0.5rem;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .copy-option:hover {
            background: #f3f4f6;
        }

        .message {
            position: relative;
        }


        .image-preview {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            display: block;
        }

        .remove-image {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-image:hover {
            background: rgba(220, 38, 38, 1);
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin: 0.5rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .file-input {
            display: none;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }



        .settings-header {
            background: #10a37f;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }



        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }



        .settings-content {
            padding: 2rem;
        }



        .setting-group {
            margin-bottom: 2rem;
        }

        .setting-group h3 {
            margin: 0 0 1rem 0;
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-hint {
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.8rem;
            font-style: italic;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .setting-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .setting-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .setting-select:focus {
            outline: none;
            border-color: #10a37f;
        }

        .setting-range {
            width: 100%;
            margin: 0.5rem 0;
        }

        .range-value {
            text-align: center;
            color: #10a37f;
            font-weight: 600;
            font-size: 0.9rem;
        }



        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 999;
        }

        .overlay.show {
            opacity: 1;
            visibility: visible;
        }








        .message.user .message-content {
            background: #10a37f;
            color: white;
        }

        .message.assistant .message-content {
            background: #2d2d2d;
            color: #ffffff;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            background: #2d2d2d;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #404040;
            flex-shrink: 0;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #171717;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 0.5rem;
        }

        .clip-icon {
            color: #8e8e8e;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .clip-icon:hover {
            color: #ffffff;
            background: #2d2d2d;
        }

        .message-input {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 0;
            font-size: 1rem;
            resize: none;
            min-height: 40px;
            max-height: 150px;
            font-family: inherit;
            background: transparent;
            color: #ffffff;
        }

        .message-input:focus {
            outline: none;
        }

        .message-input::placeholder {
            color: #8e8e8e;
        }

        .send-btn {
            padding: 1rem 2rem;
            background: #000000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .send-btn:hover {
            background: #333333;
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            color: #6b7280;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #fecaca;
        }

        .model-info {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-style: italic;
            text-align: center;
        }

        .timeout-warning {
            font-size: 0.85rem;
            color: #f59e0b;
            margin-top: 0.5rem;
            text-align: center;
            font-weight: 500;
        }

        .retry-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            margin-top: 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .retry-btn:hover {
            background: #2563eb;
        }

        .elapsed-time {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.5rem;
            text-align: center;
            font-family: monospace;
        }

        .cancel-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            margin-top: 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
            width: 100%;
        }

        .cancel-btn:hover {
            background: #dc2626;
        }

        .welcome-message {
            text-align: center;
            color: #8e8e8e;
            padding: 2rem;
            font-style: italic;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.5rem 1rem;
                flex-direction: row;
                gap: 0.5rem;
                min-height: 60px;
            }

            .header-left {
                width: auto;
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .header-right {
                width: auto;
                justify-content: flex-end;
            }

            /* Hide logo in mobile view */
            .header-logo {
                display: none;
            }

            /* Hide original new chat button in mobile view */
            .header .new-chat-btn {
                display: none;
            }

            /* Style mobile new chat button */
            .mobile-new-chat {
                padding: 0.5rem;
                font-size: 0.8rem;
                min-width: auto;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex !important;
                align-items: center;
                justify-content: center;
                background: transparent;
                color: #ffffff;
                border: 1px solid #2d2d2d;
                cursor: pointer;
                transition: all 0.3s ease;
                flex-shrink: 0;
            }

            .mobile-new-chat:hover {
                background: #2d2d2d;
                border-color: #404040;
            }

            .mobile-new-chat span {
                font-size: 1.2rem;
            }

            /* Make model selector more compact */
            .model-selector {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            .model-selector select {
                min-width: 80px;
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            .chat-container {
                padding: 1rem;
                height: calc(100vh - 80px);
            }

            .message-content {
                max-width: 85%;
            }

            .input-container {
                padding: 1rem;
                flex-direction: row;
                gap: 0.5rem;
                align-items: center;
            }

            .message-input {
                min-height: 50px;
                font-size: 1rem;
                padding: 0.75rem;
            }

            .send-btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
                min-width: 80px;
            }

            .image-container {
                gap: 0.25rem;
            }

            .image-preview img {
                max-width: 150px;
                max-height: 150px;
            }

            .settings-toggle {
                bottom: 7rem;
                right: 1.5rem;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }

        }

        @media (max-width: 480px) {
            .header {
                padding: 0.25rem 0.5rem;
                min-height: 50px;
            }

            .chat-container {
                padding: 0.5rem;
                height: calc(100vh - 70px);
            }

            .input-container {
                padding: 0.75rem;
                gap: 0.25rem;
            }

            .mobile-new-chat {
                width: 35px;
                height: 35px;
                padding: 0.25rem;
            }

            .mobile-new-chat span {
                font-size: 1rem;
            }

            .message-input {
                min-height: 45px;
                padding: 0.5rem;
                font-size: 0.95rem;
            }

            .send-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
                min-width: 70px;
            }

            .image-upload-area {
                padding: 0.5rem;
                font-size: 0.65rem;
            }

            .upload-text {
                font-size: 0.6rem;
            }

            .message-content {
                max-width: 90%;
                padding: 0.75rem;
            }

            .chat-messages {
                padding: 0.75rem;
            }

            .settings-toggle {
                bottom: 6rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

        }
    </style>
</head>
<body>


    <div class="header">
        <div class="header-left">
            <img src="logo.png" alt="AI Chatbot Logo" class="header-logo">
            <button class="new-chat-btn" id="newChatBtn">
                <span>✏️</span>
                New chat
            </button>
        </div>
        <div class="header-right">
            <div class="model-selector">
                <span>Model:</span>
                <select id="headerModelSelect">
                    <option value="gpt-5-2025-08-07">GPT-5</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
                
                <div class="settings-dropdown" id="settingsDropdown">
                    <div class="settings-section">
                        <h4>Model Selection</h4>
                        <div class="settings-item">
                            <label class="settings-label">AI Model</label>
                            <div class="model-buttons">
                                <button class="model-btn" data-model="gpt-5-2025-08-07">🧠 GPT-5</button>
                                <button class="model-btn" data-model="gpt-4o">⚡ GPT-4o</button>
                                <button class="model-btn" data-model="gpt-4o-mini">🚀 GPT-4o Mini</button>
                                <button class="model-btn" data-model="gpt-3.5-turbo">⚡ GPT-3.5</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Model Settings</h4>
                        <div class="settings-item">
                            <label class="settings-label">Max Tokens: <span id="headerMaxTokensValue">8000</span></label>
                            <input type="range" class="settings-range" id="headerMaxTokensRange" min="100" max="16000" value="8000" step="100">
                            <div class="settings-hint">💡 GPT-5 needs higher tokens for complex tasks. 8000+ recommended for long responses.</div>
                        </div>
                        
                        <div class="settings-item" id="headerReasoningEffortGroup" style="display: none;">
                            <label class="settings-label">Reasoning Effort</label>
                            <div class="reasoning-effort-buttons">
                                <button class="reasoning-effort-btn" data-effort="low">🔍 Low</button>
                                <button class="reasoning-effort-btn" data-effort="medium">🧠 Medium</button>
                                <button class="reasoning-effort-btn" data-effort="high">🎯 High</button>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <label class="settings-label">Temperature: <span id="headerTemperatureValue">0.7</span></label>
                            <input type="range" class="settings-range" id="headerTemperatureRange" min="0" max="2" value="0.7" step="0.1">
                        </div>
                    </div>
                    
                    
                </div>
            </div>
        </div>
    </div>

        <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                What awesome things are we doing today?
            </div>
        </div>

        <div class="input-container">
            <button class="new-chat-btn mobile-new-chat" id="mobileNewChatBtn" title="New chat">
                <span>✏️</span>
            </button>
            <div class="input-wrapper">
                <div class="clip-icon" id="clipIcon" title="Attach images">📎</div>
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type your message here..."
                    rows="1"
                ></textarea>
            </div>
            <div class="image-container" id="imageContainer" style="display: none;"></div>
            <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
            <button id="sendBtn" class="send-btn">
                <span id="sendBtnText">Send</span>
                <div id="loadingSpinner" class="loading" style="display: none;"></div>
            </button>
        </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>⚙️ Settings</h2>
            <button class="close-settings" id="closeSettings">×</button>
        </div>
        <div class="settings-content">

            <div class="setting-group">
                <h3>AI Model Configuration</h3>
                
                <div class="setting-item">
                    <label class="setting-label">Model</label>
                    <select class="setting-select" id="modelSelect">
                        <option value="gpt-5-2025-08-07">GPT-5 (2025-08-07)</option>
                        <option value="gpt-4o">GPT-4o (Latest)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>



                <div class="setting-item">
                    <label class="setting-label">Max Tokens: <span id="maxTokensValue">8000</span></label>
                    <input type="range" class="setting-range" id="maxTokensRange" min="100" max="16000" value="8000" step="100">
                    <div class="setting-hint">💡 GPT-5 needs higher tokens for complex tasks. 8000+ recommended for long responses.</div>
                </div>

                <div class="setting-item" id="reasoningEffortGroup" style="display: none;">
                    <label class="setting-label">Reasoning Effort</label>
                    <div class="reasoning-effort-buttons">
                        <button class="reasoning-effort-btn" data-effort="low">🔍 Low</button>
                        <button class="reasoning-effort-btn" data-effort="medium">🧠 Medium</button>
                        <button class="reasoning-effort-btn" data-effort="high">🎯 High</button>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Temperature: <span id="temperatureValue">0.7</span></label>
                    <input type="range" class="setting-range" id="temperatureRange" min="0" max="2" value="0.7" step="0.1">
                </div>
            </div>

        </div>
    </div>


    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>


    <script>
        class ChatBot {
            constructor() {
                // Use our backend API endpoint
                this.apiEndpoint = '/api/chat';
                
                this.messages = [];
                this.isLoading = false;
                this.attachedImages = [];
                
                // Load settings from localStorage with fallback to defaults
                this.settings = {
                    model: localStorage.getItem('chatbot_model') || 'gpt-5-2025-08-07',
                    reasoningEffort: localStorage.getItem('chatbot_reasoning_effort') || 'high',
                    maxTokens: parseInt(localStorage.getItem('chatbot_max_tokens')) || 8000,
                    temperature: parseFloat(localStorage.getItem('chatbot_temperature')) || 0.7
                };
                
                this.initializeElements();
                this.bindEvents();
                this.updateUI();
                this.updateReasoningEffortVisibility();
                this.updateSettingsUI();
                
                // No API key testing needed - handled by backend
            }

            initializeElements() {
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.sendBtnText = document.getElementById('sendBtnText');
                this.loadingSpinner = document.getElementById('loadingSpinner');
                this.clipIcon = document.getElementById('clipIcon');
                this.fileInput = document.getElementById('fileInput');
                this.imageContainer = document.getElementById('imageContainer');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.mobileNewChatBtn = document.getElementById('mobileNewChatBtn');
                this.headerModelSelect = document.getElementById('headerModelSelect');
                this.settingsDropdown = document.getElementById('settingsDropdown');
                this.modelSelectorContainer = document.querySelector('.model-selector');
                this.modelButtons = document.querySelectorAll('.model-btn');
                
                // Debug: Check if elements are found
                console.log('settingsDropdown found:', !!this.settingsDropdown);
                console.log('modelSelectorContainer found:', !!this.modelSelectorContainer);
                console.log('modelButtons found:', this.modelButtons.length);
                
                // Header settings elements
                this.headerMaxTokensRange = document.getElementById('headerMaxTokensRange');
                this.headerMaxTokensValue = document.getElementById('headerMaxTokensValue');
                this.headerReasoningEffortGroup = document.getElementById('headerReasoningEffortGroup');
                this.headerReasoningEffortButtons = document.querySelectorAll('#headerReasoningEffortGroup .reasoning-effort-btn');
                this.headerTemperatureRange = document.getElementById('headerTemperatureRange');
                this.headerTemperatureValue = document.getElementById('headerTemperatureValue');
                // Removed references to non-existent elements
                
                // Settings elements
                this.settingsPanel = document.getElementById('settingsPanel');
                this.closeSettings = document.getElementById('closeSettings');
                this.overlay = document.getElementById('overlay');
                this.modelSelect = document.getElementById('modelSelect');
                this.reasoningEffortGroup = document.getElementById('reasoningEffortGroup');
                this.reasoningEffortButtons = document.querySelectorAll('.reasoning-effort-btn');

                this.maxTokensRange = document.getElementById('maxTokensRange');
                this.maxTokensValue = document.getElementById('maxTokensValue');
                this.temperatureRange = document.getElementById('temperatureRange');
                this.temperatureValue = document.getElementById('temperatureValue');
                this.currentSettings = document.getElementById('currentSettings');
                this.resetDefaultsBtn = document.getElementById('resetDefaultsBtn');
            }

            bindEvents() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.newChatBtn.addEventListener('click', () => {
                    this.startNewChat();
                });
                this.mobileNewChatBtn.addEventListener('click', () => {
                    this.startNewChat();
                });
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 150) + 'px';
                });

                // Image upload events
                this.clipIcon.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

                // Clipboard paste events
                document.addEventListener('paste', (e) => {
                    const items = Array.from(e.clipboardData.items);
                    const imageItems = items.filter(item => item.type.startsWith('image/'));
                    
                    if (imageItems.length > 0) {
                        e.preventDefault();
                        this.processClipboardImages(imageItems);
                    }
                });

                // Settings dropdown events
                this.modelSelectorContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Model selector clicked!');
                    
                    // Check if dropdown is currently shown
                    const isCurrentlyShown = this.settingsDropdown.classList.contains('show');
                    console.log('Currently shown:', isCurrentlyShown);
                    
                    if (isCurrentlyShown) {
                        this.settingsDropdown.classList.remove('show');
                        console.log('Dropdown hidden');
                    } else {
                        this.settingsDropdown.classList.add('show');
                        console.log('Dropdown shown');
                    }
                });


                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    // Small delay to prevent immediate closing
                    setTimeout(() => {
                        if (!this.modelSelectorContainer.contains(e.target) && !this.settingsDropdown.contains(e.target)) {
                            this.settingsDropdown.classList.remove('show');
                            console.log('Dropdown closed by outside click');
                        }
                    }, 10);
                });

                // Prevent dropdown from closing when clicking inside it, but allow native dropdowns to work
                this.settingsDropdown.addEventListener('click', (e) => {
                    console.log('Settings dropdown clicked, target:', e.target.tagName);
                    // Only stop propagation if it's not a select element
                    if (e.target.tagName !== 'SELECT') {
                        e.stopPropagation();
                        console.log('Stopped propagation for non-select element');
                    } else {
                        console.log('Allow select element to work normally');
                    }
                });

                // Header settings controls
                this.headerMaxTokensRange.addEventListener('input', (e) => {
                    e.stopPropagation();
                    this.settings.maxTokens = parseInt(e.target.value);
                    this.headerMaxTokensValue.textContent = e.target.value;
                    this.saveSettings();
                    this.updateSettingsUI();
                });

                this.headerReasoningEffortButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.settings.reasoningEffort = button.dataset.effort;
                        this.saveSettings();
                        this.updateSettingsUI();
                    });
                });

                this.headerTemperatureRange.addEventListener('input', (e) => {
                    e.stopPropagation();
                    this.settings.temperature = parseFloat(e.target.value);
                    this.headerTemperatureValue.textContent = e.target.value;
                    this.saveSettings();
                    this.updateSettingsUI();
                });

                // Model button event listeners
                this.modelButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const model = button.dataset.model;
                        console.log('Model button clicked:', model);
                        
                        // Remove active class from all buttons
                        this.modelButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        button.classList.add('active');
                        
                        // Update settings
                        this.settings.model = model;
                        this.updateReasoningEffortVisibility();
                        this.saveSettings();
                        this.updateSettingsUI();
                    });
                });

                // Removed event listener for non-existent element


                // Settings events
                this.closeSettings.addEventListener('click', () => this.closeSettingsPanel());
                this.overlay.addEventListener('click', () => this.closeSettingsPanel());
                
                this.modelSelect.addEventListener('change', (e) => {
                    this.settings.model = e.target.value;
                    this.updateReasoningEffortVisibility();
                    this.saveSettings();
                    this.updateSettingsUI();
                });
                
                this.reasoningEffortButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.settings.reasoningEffort = button.dataset.effort;
                        this.saveSettings();
                        this.updateSettingsUI();
                    });
                });
                

                
                this.maxTokensRange.addEventListener('input', (e) => {
                    this.settings.maxTokens = parseInt(e.target.value);
                    this.maxTokensValue.textContent = e.target.value;
                    this.saveSettings();
                    this.updateSettingsUI();
                });
                
                this.temperatureRange.addEventListener('input', (e) => {
                    this.settings.temperature = parseFloat(e.target.value);
                    this.temperatureValue.textContent = e.target.value;
                    this.saveSettings();
                    this.updateSettingsUI();
                });
                
                this.resetDefaultsBtn.addEventListener('click', () => {
                    this.resetToDefaults();
                });

            }



            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message && this.attachedImages.length === 0) return;

                this.addMessage(message, 'user', this.attachedImages);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.clearAttachedImages();
                
                // Maintain focus on the input field
                this.messageInput.focus();
                
                await this.getAIResponse(message);
            }

            addMessage(content, role, images = []) {
                const message = { role, content, images, timestamp: new Date() };
                this.messages.push(message);
                this.displayMessage(message);
            }

            displayMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                if (message.role === 'user') {
                    avatar.textContent = '👤';
                } else {
                    // Use botpic.png for assistant messages
                    const avatarImg = document.createElement('img');
                    avatarImg.src = 'botpic.png';
                    avatarImg.alt = 'AI Assistant';
                    avatar.appendChild(avatarImg);
                }

                const content = document.createElement('div');
                content.className = 'message-content';
                
                // Add images if present
                if (message.images && message.images.length > 0) {
                    message.images.forEach(imageData => {
                        const img = document.createElement('img');
                        img.src = imageData;
                        img.className = 'message-image';
                        img.alt = 'Uploaded image';
                        content.appendChild(img);
                    });
                }
                
                // Format the content with proper HTML structure
                if (message.content) {
                    const textContent = document.createElement('div');
                    textContent.innerHTML = this.formatMessageContent(message.content);
                    content.appendChild(textContent);
                }

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);

                // Add copy button for assistant messages
                if (message.role === 'assistant') {
                    this.addCopyButton(messageDiv, message.content);
                }

                // Remove welcome message if it exists
                const welcomeMessage = this.chatMessages.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }

                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;

                // Render math equations safely once MathJax is ready
                if (message.role === 'assistant') {
                    const runTypeset = () => {
                        try {
                            if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
                                MathJax.typesetPromise([content]).catch((err) => console.log('MathJax error:', err));
                            } else if (window.MathJax && typeof MathJax.typeset === 'function') {
                                MathJax.typeset([content]);
                            }
                        } catch (e) {
                            console.log('MathJax typeset failed:', e);
                        }
                    };
                    if (window.MathJax && MathJax.startup && MathJax.startup.promise) {
                        MathJax.startup.promise.then(runTypeset).catch(runTypeset);
                    } else {
                        // If script hasn't loaded yet, wait a tick
                        setTimeout(runTypeset, 50);
                    }
                }
            }

            addCopyButton(messageDiv, originalContent) {
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '📋 Copy';
                
                const copyOptions = document.createElement('div');
                copyOptions.className = 'copy-options';
                copyOptions.innerHTML = `
                    <button class="copy-option" data-type="formatted">📄 Copy as Formatted</button>
                    <button class="copy-option" data-type="plain">📝 Copy as Plain Text</button>
                    <button class="copy-option" data-type="latex">🔢 Copy LaTeX Only</button>
                    <button class="copy-option" data-type="markdown">🔗 Copy Markdown</button>
                `;

                messageDiv.appendChild(copyButton);
                messageDiv.appendChild(copyOptions);

                copyButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyOptions.classList.toggle('show');
                });

                // Close copy options when clicking outside
                document.addEventListener('click', (e) => {
                    if (!messageDiv.contains(e.target)) {
                        copyOptions.classList.remove('show');
                    }
                });

                copyOptions.addEventListener('click', (e) => {
                    if (e.target.classList.contains('copy-option')) {
                        const copyType = e.target.dataset.type;
                        this.copyContent(originalContent, copyType);
                        copyOptions.classList.remove('show');
                        
                        // Show feedback
                        const originalText = copyButton.textContent;
                        copyButton.textContent = '✅ Copied!';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                        }, 2000);
                    }
                });
            }



            copyContent(content, type) {
                let textToCopy = '';

                switch (type) {
                    case 'formatted':
                        // Copy as rich text (HTML) - works well with Word
                        textToCopy = this.convertToRichText(content);
                        this.copyToClipboard(textToCopy, 'text/html');
                        break;
                    
                    case 'plain':
                        // Copy as plain text with LaTeX preserved
                        textToCopy = this.convertToPlainText(content);
                        this.copyToClipboard(textToCopy, 'text/plain');
                        break;
                    
                    case 'latex':
                        // Copy only LaTeX equations
                        textToCopy = this.extractLatexOnly(content);
                        this.copyToClipboard(textToCopy, 'text/plain');
                        break;
                    case 'markdown':
                        // Copy original markdown/content as-is
                        textToCopy = content || '';
                        this.copyToClipboard(textToCopy, 'text/plain');
                        break;
                }
            }

            convertToRichText(content) {
                // Convert markdown to HTML and preserve LaTeX
                let html = this.formatMessageContent(content);
                
                // Replace LaTeX with Unicode approximations for better Word compatibility
                html = html.replace(/\\\(/g, '(');
                html = html.replace(/\\\)/g, ')');
                html = html.replace(/\\\[/g, '[');
                html = html.replace(/\\\]/g, ']');
                
                return html;
            }



            convertToPlainText(content) {
                // Convert to plain text while preserving LaTeX
                let text = content;
                
                // Remove markdown formatting but keep LaTeX
                text = text.replace(/\*\*(.*?)\*\*/g, '$1');
                text = text.replace(/\*(.*?)\*/g, '$1');
                text = text.replace(/`([^`]+)`/g, '$1');
                text = text.replace(/^#+\s+/gm, '');
                text = text.replace(/^>\s+/gm, '');
                text = text.replace(/^\*?\s+/gm, '• ');
                
                return text;
            }

            extractLatexOnly(content) {
                const latexRegex = /\\\(([\s\S]*?)\\\)|\\\[([\s\S]*?)\\\]/g;
                const matches = [];
                let match;
                
                while ((match = latexRegex.exec(content)) !== null) {
                    if (match[1]) {
                        matches.push(`Inline: \\(${match[1]}\\)`);
                    } else if (match[2]) {
                        matches.push(`Display: \\[${match[2]}\\]`);
                    }
                }
                
                return matches.join('\n\n');
            }

            async copyToClipboard(text, mimeType) {
                try {
                    if (mimeType === 'text/html') {
                        // For rich text copying
                        const blob = new Blob([text], { type: mimeType });
                        const data = [new ClipboardItem({ [mimeType]: blob })];
                        await navigator.clipboard.write(data);
                    } else {
                        // For plain text copying
                        await navigator.clipboard.writeText(text);
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
            }

            formatMessageContent(content) {
                // Convert markdown-style formatting to HTML
                let formatted = content
                    // Headers
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    
                    // Bold and italic
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    
                    // Code blocks
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    
                    // Blockquotes
                    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                    
                    // Line breaks
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');

                // Process lists with proper nesting support
                formatted = this.processLists(formatted);

                // Wrap in paragraphs
                formatted = '<p>' + formatted + '</p>';
                
                // Clean up empty paragraphs
                formatted = formatted.replace(/<p><\/p>/g, '');
                formatted = formatted.replace(/<p><br><\/p>/g, '');
                
                return formatted;
            }

            processLists(content) {
                const lines = content.split('<br>');
                const result = [];
                let i = 0;
                
                while (i < lines.length) {
                    const line = lines[i];
                    
                    // Check if this line is a list item
                    const listMatch = line.match(/^(\s*)([\*\-\+]|\d+\.)\s+(.*)$/);
                    
                    if (listMatch) {
                        const [, indent, marker, text] = listMatch;
                        const indentLevel = Math.floor(indent.length / 2); // Assuming 2 spaces per level
                        
                        // Process the list starting from this line
                        const listResult = this.processListFromLine(lines, i, indentLevel);
                        result.push(listResult.html);
                        i = listResult.nextIndex;
                    } else {
                        result.push(line);
                        i++;
                    }
                }
                
                return result.join('<br>');
            }

            processListFromLine(lines, startIndex, baseIndentLevel) {
                const listItems = [];
                let i = startIndex;
                let currentIndentLevel = baseIndentLevel;
                
                while (i < lines.length) {
                    const line = lines[i];
                    const listMatch = line.match(/^(\s*)([\*\-\+]|\d+\.)\s+(.*)$/);
                    
                    if (!listMatch) {
                        // Not a list item, stop processing
                        break;
                    }
                    
                    const [, indent, marker, text] = listMatch;
                    const indentLevel = Math.floor(indent.length / 2);
                    
                    if (indentLevel < baseIndentLevel) {
                        // This item is at a higher level, stop processing
                        break;
                    }
                    
                    if (indentLevel === baseIndentLevel) {
                        // This is a top-level item
                        listItems.push({
                            text: text,
                            indentLevel: indentLevel,
                            marker: marker
                        });
                    } else {
                        // This is a nested item, we'll handle it in the next iteration
                        i--;
                        break;
                    }
                    
                    i++;
                }
                
                // Generate HTML for this list
                const isOrdered = /^\d+\.$/.test(listItems[0]?.marker);
                const listTag = isOrdered ? 'ol' : 'ul';
                let html = `<${listTag}>`;
                
                for (let j = 0; j < listItems.length; j++) {
                    const item = listItems[j];
                    html += `<li>${item.text}`;
                    
                    // Check if there are nested items
                    if (i < lines.length) {
                        const nextLine = lines[i];
                        const nextMatch = nextLine.match(/^(\s*)([\*\-\+]|\d+\.)\s+(.*)$/);
                        
                        if (nextMatch) {
                            const [, nextIndent] = nextMatch;
                            const nextIndentLevel = Math.floor(nextIndent.length / 2);
                            
                            if (nextIndentLevel > baseIndentLevel) {
                                // There are nested items
                                const nestedResult = this.processListFromLine(lines, i, nextIndentLevel);
                                html += nestedResult.html;
                                i = nestedResult.nextIndex;
                            }
                        }
                    }
                    
                    html += '</li>';
                }
                
                html += `</${listTag}>`;
                
                return { html, nextIndex: i };
            }

            async getAIResponse(userMessage) {
                this.setLoading(true);
                this.showTypingIndicator();

                // Set timeout based on model - GPT-5 models can take longer
                const timeoutDuration = this.settings.model.startsWith('gpt-5') ? 180000 : 60000; // 3 min for GPT-5, 1 min for others
                let timeoutId;
                this.currentTimeoutId = timeoutId; // Store for cancellation

                try {
                    // Get the last user message with images
                    const lastUserMessage = this.messages[this.messages.length - 1];
                    const hasImages = lastUserMessage.images && lastUserMessage.images.length > 0;

                    let messages = [
                        { role: 'system', content: 'You are a helpful AI assistant. Provide clear, concise, and helpful responses. When writing mathematical equations, use LaTeX format with inline math using \\( \\) and display math using \\[ \\]. Format your responses with proper spacing, paragraphs, bullet points, and markdown-style formatting for better readability.' }
                    ];

                    // Add conversation history (without images for previous messages)
                    for (let i = 0; i < this.messages.length - 1; i++) {
                        const msg = this.messages[i];
                        messages.push({ role: msg.role, content: msg.content });
                    }

                    // Add the current user message
                    if (hasImages) {
                        const content = [
                            { type: 'text', text: userMessage || 'Please analyze this image.' }
                        ];
                        
                        // Add images to the message
                        lastUserMessage.images.forEach(imageData => {
                            content.push({
                                type: 'image_url',
                                image_url: {
                                    url: imageData
                                }
                            });
                        });
                        
                        messages.push({ role: 'user', content });
                    } else {
                        messages.push({ role: 'user', content: userMessage });
                    }

                    const requestBody = {
                        model: this.settings.model,
                        messages: messages,
                        maxTokens: this.settings.maxTokens,
                        temperature: this.settings.temperature,
                        reasoningEffort: this.settings.reasoningEffort
                    };

                    console.log('API Request:', {
                        model: this.settings.model,
                        maxTokens: this.settings.maxTokens,
                        temperature: this.settings.temperature,
                        messageCount: messages.length,
                        requestBody: requestBody
                    });

                    // Create a promise that rejects on timeout
                    const timeoutPromise = new Promise((_, reject) => {
                        timeoutId = setTimeout(() => {
                            reject(new Error(`Request timed out after ${timeoutDuration / 1000} seconds. The GPT-5 model may be taking longer than expected. Please try again or switch to a faster model.`));
                        }, timeoutDuration);
                        this.currentTimeoutId = timeoutId; // Store for cancellation
                    });

                    console.log('Making fetch request to:', this.apiEndpoint);
                    
                    // Create the fetch promise - no authorization header needed, handled by backend
                    const fetchPromise = fetch(this.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    // Race between fetch and timeout
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    console.log('Response received:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });

                    // Clear timeout since fetch succeeded
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }

                    if (!response.ok) {
                        let details = '';
                        try {
                            const errJson = await response.json();
                            details = errJson?.error || errJson?.message || JSON.stringify(errJson);
                        } catch (_) {
                            try {
                                details = await response.text();
                            } catch (_) {
                                details = '';
                            }
                        }
                        throw new Error(`API request failed: ${response.status}${details ? ' - ' + details : ''}`);
                    }

                    const responseData = await response.json();
                    console.log('API Response:', responseData);
                    
                    if (!responseData.success) {
                        throw new Error(responseData.error || 'Unknown error from backend');
                    }
                    
                    const data = responseData.data;
                    const aiResponse = data.choices[0].message.content;
                    
                    // Check if response was cut off due to token limits
                    if (!aiResponse || aiResponse.trim() === '') {
                        if (data.choices[0].finish_reason === 'length') {
                            throw new Error('Response was cut off due to token limit. Please increase max tokens or try a shorter request.');
                        } else {
                            throw new Error('Received empty response from API. Please try again.');
                        }
                    }
                    
                    this.removeTypingIndicator();
                    this.addMessage(aiResponse, 'assistant');

                } catch (error) {
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    this.removeTypingIndicator();
                    
                    // Provide more helpful error messages based on error type
                    let errorMessage = error.message;
                    
                    if (error.message.includes('timed out')) {
                        errorMessage = `⏰ ${error.message}`;
                        // Show retry button for timeout errors
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage = `🌐 Network error: Please check your internet connection and try again.`;
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else if (error.message.includes('API request failed: 429')) {
                        errorMessage = `🚫 Rate limit exceeded: Please wait a moment before trying again.`;
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else if (error.message.includes('API request failed: 500')) {
                        errorMessage = `🔧 Server error: Please try again in a few moments.`;
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else if (error.message.includes('API request failed: 401')) {
                        errorMessage = `🔑 Authentication error: Please check your API key configuration.`;
                        this.showError(errorMessage);
                    } else if (error.message.includes('token limit')) {
                        errorMessage = `📏 ${error.message} Current limit: ${this.settings.maxTokens} tokens. Try increasing max tokens in settings.`;
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else if (error.message.includes('empty response')) {
                        errorMessage = `📭 ${error.message}`;
                        this.showError(errorMessage, true, () => this.getAIResponse(userMessage));
                    } else {
                        this.showError(errorMessage);
                    }
                } finally {
                    // Clear timeout if it still exists
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                    
                    // Clear current timeout ID
                    this.currentTimeoutId = null;
                    
                    this.setLoading(false);
                    // Ensure input field is focused after response
                    this.messageInput.focus();
                }
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message assistant typing-indicator';
                typingDiv.id = 'typingIndicator';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                // Use botpic.png for typing indicator
                const avatarImg = document.createElement('img');
                avatarImg.src = 'botpic.png';
                avatarImg.alt = 'AI Assistant';
                avatar.appendChild(avatarImg);

                const content = document.createElement('div');
                content.className = 'message-content';
                

                
                // Show different messages based on model type
                const isGPT5 = this.settings.model.startsWith('gpt-5');
                const modelInfo = isGPT5 ? 
                    '<div class="model-info">GPT-5 Thinking Model - This may take longer</div>' : '';
                
                const cancelButton = isGPT5 ? 
                    '<button class="cancel-btn" onclick="chatbot.cancelRequest()">❌ Cancel Request</button>' : '';
                
                content.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    ${modelInfo}
                    ${cancelButton}
                `;

                typingDiv.appendChild(avatar);
                typingDiv.appendChild(content);
                this.chatMessages.appendChild(typingDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // Start timeout warning for GPT-5 models
                if (isGPT5) {
                    setTimeout(() => {
                        this.updateTypingIndicatorWithTimeout();
                    }, 30000); // Show timeout warning after 30 seconds
                    
                    // Start elapsed time counter
                    this.startElapsedTimeCounter();
                }
                

            }
            
            updateTypingIndicatorWithTimeout() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    const content = typingIndicator.querySelector('.message-content');
                    if (content) {
                        const timeoutWarning = document.createElement('div');
                        timeoutWarning.className = 'timeout-warning';
                        timeoutWarning.innerHTML = '⏰ Still thinking... This may take a few more moments';
                        content.appendChild(timeoutWarning);
                    }
                }
            }
            
            startElapsedTimeCounter() {
                const startTime = Date.now();
                this.elapsedTimeInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    this.updateElapsedTime(elapsed);
                }, 1000);
            }
            
            updateElapsedTime(seconds) {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    let elapsedTimeDiv = typingIndicator.querySelector('.elapsed-time');
                    if (!elapsedTimeDiv) {
                        elapsedTimeDiv = document.createElement('div');
                        elapsedTimeDiv.className = 'elapsed-time';
                        const content = typingIndicator.querySelector('.message-content');
                        if (content) {
                            content.appendChild(elapsedTimeDiv);
                        }
                    }
                    
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    elapsedTimeDiv.textContent = `⏱️ Elapsed time: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }
            }
            
            stopElapsedTimeCounter() {
                if (this.elapsedTimeInterval) {
                    clearInterval(this.elapsedTimeInterval);
                    this.elapsedTimeInterval = null;
                }
            }
            
            cancelRequest() {
                // Clear any pending timeouts
                if (this.currentTimeoutId) {
                    clearTimeout(this.currentTimeoutId);
                    this.currentTimeoutId = null;
                }
                
                // Stop elapsed time counter
                this.stopElapsedTimeCounter();
                
                // Remove typing indicator
                this.removeTypingIndicator();
                
                // Reset loading state
                this.setLoading(false);
                
                // Show cancellation message
                this.showError('Request cancelled by user', false);
                
                // Focus back on input
                this.messageInput.focus();
            }
            

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                // Stop elapsed time counter
                this.stopElapsedTimeCounter();
            }

            setLoading(loading) {
                this.isLoading = loading;
                this.sendBtn.disabled = loading;
                this.messageInput.disabled = loading;
                
                if (loading) {
                    this.sendBtnText.style.display = 'none';
                    this.loadingSpinner.style.display = 'inline-block';
                } else {
                    this.sendBtnText.style.display = 'inline';
                    this.loadingSpinner.style.display = 'none';
                }
            }

            showError(message, showRetry = false, retryAction = null) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                
                const messageText = document.createElement('div');
                messageText.textContent = message;
                errorDiv.appendChild(messageText);
                
                // Add retry button if requested
                if (showRetry && retryAction) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = '🔄 Retry';
                    retryBtn.onclick = () => {
                        errorDiv.remove();
                        retryAction();
                    };
                    errorDiv.appendChild(retryBtn);
                }
                
                this.chatMessages.appendChild(errorDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // Auto-remove after 10 seconds if no retry button
                if (!showRetry) {
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 10000);
                }
            }

            showMessage(content, role) {
                const message = { role, content, timestamp: new Date() };
                this.displayMessage(message);
            }

            updateUI() {
                // UI is now clean and ready for chat
                // No additional setup needed
            }

            handleFileSelect(event) {
                const files = Array.from(event.target.files);
                this.processImageFiles(files);
                event.target.value = ''; // Reset file input
            }

            processImageFiles(files) {
                const imageFiles = files.filter(file => file.type.startsWith('image/'));
                if (imageFiles.length === 0) {
                    this.showError('Please select image files only');
                    return;
                }

                imageFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.addImagePreview(e.target.result, file.name);
                        this.attachedImages.push(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            }

            processClipboardImages(imageItems) {
                imageItems.forEach(item => {
                    const file = item.getAsFile();
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.addImagePreview(e.target.result, 'Pasted Image');
                            this.attachedImages.push(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            addImagePreview(imageData, fileName) {
                this.imageContainer.style.display = 'flex';
                
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.alt = fileName;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image';
                removeBtn.textContent = '×';
                removeBtn.onclick = () => {
                    const index = this.attachedImages.indexOf(imageData);
                    if (index > -1) {
                        this.attachedImages.splice(index, 1);
                    }
                    previewDiv.remove();
                    if (this.attachedImages.length === 0) {
                        this.imageContainer.style.display = 'none';
                    }
                };
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(removeBtn);
                this.imageContainer.appendChild(previewDiv);
            }

            clearAttachedImages() {
                this.attachedImages = [];
                this.imageContainer.innerHTML = '';
                this.imageContainer.style.display = 'none';
            }

            // Settings Management Methods
            openSettings() {
                this.settingsPanel.classList.add('open');
                this.overlay.classList.add('show');
            }

            closeSettingsPanel() {
                this.settingsPanel.classList.remove('open');
                this.overlay.classList.remove('show');
            }



            updateReasoningEffortVisibility() {
                if (this.settings.model === 'gpt-5-2025-08-07') {
                    this.reasoningEffortGroup.style.display = 'block';
                    this.headerReasoningEffortGroup.style.display = 'block';
                } else {
                    this.reasoningEffortGroup.style.display = 'none';
                    this.headerReasoningEffortGroup.style.display = 'none';
                }
            }
            
            updateSettingsUI() {
                // Update form values
                this.modelSelect.value = this.settings.model;
                this.headerModelSelect.value = this.settings.model;
                // Update reasoning effort buttons
                this.reasoningEffortButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.effort === this.settings.reasoningEffort);
                });
                this.headerReasoningEffortButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.effort === this.settings.reasoningEffort);
                });
                
                // Update model buttons
                this.modelButtons.forEach(button => {
                    if (button.dataset.model === this.settings.model) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
                this.maxTokensRange.value = this.settings.maxTokens;
                this.maxTokensValue.textContent = this.settings.maxTokens;
                this.headerMaxTokensRange.value = this.settings.maxTokens;
                this.headerMaxTokensValue.textContent = this.settings.maxTokens;
                this.temperatureRange.value = this.settings.temperature;
                this.temperatureValue.textContent = this.settings.temperature;
                this.headerTemperatureRange.value = this.settings.temperature;
                this.headerTemperatureValue.textContent = this.settings.temperature;



                // Update current settings display
                let settingsText = `Model: ${this.settings.model}<br>`;
                settingsText += `Max Tokens: ${this.settings.maxTokens}<br>`;
                settingsText += `Temperature: ${this.settings.temperature}`;
                
                if (this.settings.model === 'gpt-5-2025-08-07') {
                    settingsText += `<br>Reasoning Effort: ${this.settings.reasoningEffort}`;
                }

                this.currentSettings.innerHTML = settingsText;
            }

            saveSettings() {
                localStorage.setItem('chatbot_model', this.settings.model);
                localStorage.setItem('chatbot_reasoning_effort', this.settings.reasoningEffort);
                localStorage.setItem('chatbot_max_tokens', this.settings.maxTokens.toString());
                localStorage.setItem('chatbot_temperature', this.settings.temperature.toString());
            }

            resetToDefaults() {
                // Clear localStorage to reset to defaults
                localStorage.removeItem('chatbot_model');
                localStorage.removeItem('chatbot_reasoning_effort');
                localStorage.removeItem('chatbot_max_tokens');
                localStorage.removeItem('chatbot_temperature');
                
                // Reset settings to defaults
                this.settings = {
                    model: 'gpt-5-2025-08-07',
                    reasoningEffort: 'high',
                    maxTokens: 8000,
                    temperature: 0.7
                };
                
                // Update UI
                this.updateSettingsUI();
                
                // Show confirmation
                alert('Settings reset to GPT-5 High Reasoning!');
            }

            startNewChat() {
                // Clear all messages
                this.messages = [];
                
                // Clear the chat display
                this.chatMessages.innerHTML = `
                    <div class="welcome-message">
                        👋 Welcome! Start chatting with AI.
                    </div>
                `;
                
                // Clear any attached images
                this.clearAttachedImages();
                
                // Clear the input field
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                // Focus on the input field
                this.messageInput.focus();
                
                // Remove any error messages
                const errorMessages = this.chatMessages.querySelectorAll('.error-message');
                errorMessages.forEach(msg => msg.remove());
                
                // Remove typing indicator if present
                this.removeTypingIndicator();
            }


            // Chat Interface Management
            enableChatInterface() {
                this.messageInput.disabled = false;
                this.sendBtn.disabled = false;
                this.newChatBtn.disabled = false;
                this.messageInput.focus();
            }





        }

        // Initialize the chatbot when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatBot();
        });
    </script>
</body>
</html>
